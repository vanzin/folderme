#!/usr/bin/env python3
# SPDX-License-Identifier: BSD-2-Clause

import app
import argparse
import browser
import config
import ipc
import lastfm
import media
import osd
import playlist
import randomizer
import sys
import time
import util
from PyQt5.QtGui import QIcon
from PyQt5.QtWidgets import QMainWindow, QMenu, QSystemTrayIcon


class TrayIcon(QSystemTrayIcon, util.Listener):
    def __init__(self, ui):
        QSystemTrayIcon.__init__(self, QIcon(util.icon("folderme.png")))
        self.ui = ui

        menu = QMenu()

        a = menu.addAction(QIcon(util.icon("play.png")), "Play")
        a.triggered.connect(app.get().playlist.playpause)

        a = menu.addAction(QIcon(util.icon("pause.png")), "Pause")
        a.triggered.connect(app.get().playlist.playpause)

        a = menu.addAction(QIcon(util.icon("stop.png")), "Stop")
        a.triggered.connect(app.get().playlist.playpause)

        a = menu.addAction(QIcon(util.icon("quit.png")), "Quit")
        a.triggered.connect(self.ui.handleQuit)

        self.setContextMenu(menu)

        self.activated.connect(self._activated)
        self.setToolTip("Stopped")
        app.get().playlist.add_listener(self)

    def _activated(self, reason):
        if reason != self.Trigger:
            return

        if self.ui.isVisible():
            self.ui.hide()
        else:
            self.ui.show()

    def track_playing(self, track):
        self.setToolTip(f"Playing: {track.artist} - {track.title}")

    def track_paused(self, track):
        self.setToolTip(f"Paused: {track.artist} - {track.title}")

    def track_stopped(self, track):
        self.setToolTip(f"Stopped")


class MainWindow(QMainWindow, util.EventSource, util.Listener):
    def __init__(self, args):
        QMainWindow.__init__(self)
        util.EventSource.__init__(self)
        util.init_ui(self, "main.ui")

        c = app.get().collection
        c.add_listener(self)

        p = app.get().playlist
        p.init_ui(self)
        self.osd = osd.OSD(p)

        self.driver = randomizer.Randomizer()

        self.playPause.clicked.connect(self.handlePlayPause)
        self.quit.clicked.connect(self.handleQuit)
        self.next.clicked.connect(p.next)
        self.previous.clicked.connect(p.prev)
        self.stop.clicked.connect(p.stop)

        tools = QMenu()

        a = tools.addAction("Browser")
        a.triggered.connect(self.show_browser)

        a = tools.addAction("Next Album")
        a.triggered.connect(self.driver.pick_next)

        a = tools.addAction("Rescan Collection")
        a.triggered.connect(self.rescan)

        a = tools.addAction("Config")
        a.triggered.connect(self.show_config)

        self.bTools.setMenu(tools)

        self.playlistUI.setFocus()
        util.restore_ui(self, "main")

    def handlePlayPause(self):
        if not app.get().playlist.albums:
            self.driver.pick_next()
        app.get().playlist.playpause()

    def handleQuit(self):
        self.fire_event(util.Listener.ui_exit)
        util.save_ui(self, "main")
        app.get().exit()

    def resizeEvent(self, e):
        QMainWindow.resizeEvent(self, e)
        self.fire_event(util.Listener.ui_resized, self)

    def showEvent(self, e):
        QMainWindow.showEvent(self, e)
        self.fire_event(util.Listener.ui_resized, self)

    def closeEvent(self, e):
        util.save_ui(self, "main")
        QMainWindow.closeEvent(self, e)

    def show_browser(self):
        browser.BrowseDialog(self).show()

    def show_config(self):
        cfg = config.ConfigDialog()
        cfg.exec()

    def collection_changed(self):
        self.repaint()

    def rescan(self):
        dlg = browser.ScanDialog(self)
        app.get().collection.scan(dlg)
        dlg.setModal(True)
        dlg.exec()

    def scan_done(self):
        pass


def start(args):
    app.init(args)

    if not app.get().collection.albums:
        cfg = config.ConfigDialog()
        cfg.exec()

    mainUI = MainWindow(args)

    if not args.no_dbus:
        server = ipc.Server(mainUI)

    tray = TrayIcon(mainUI)
    tray.show()

    if args.show:
        mainUI.show()

    sys.exit(app.get().exec())


def main(argv):
    parser = argparse.ArgumentParser(description="FolderME music player")
    parser.add_argument(
        "--remote", metavar="CMD", help="send CMD to FolderME dbus service"
    )
    parser.add_argument(
        "--show", action="store_true", default=False, help="show UI on startup"
    )
    parser.add_argument(
        "--no-dbus",
        action="store_true",
        default=False,
        help="do not start dbus service",
    )
    parser.add_argument(
        "--no-lastfm",
        action="store_true",
        default=False,
        help="do not scrobble to last.fm",
    )
    args = parser.parse_args(argv[1:])

    if args.remote:
        ipc.send(args.remote)
        sys.exit(0)

    start(args)


if __name__ == "__main__":
    main(sys.argv)
